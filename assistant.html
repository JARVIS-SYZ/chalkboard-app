<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Chalkboard Assistant</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0b0b0b;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    
    .header {
      padding: 10px 16px;
      border-bottom: 1px solid #333;
      text-align: center;
      flex-shrink: 0;
    }
    
    .title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .room-info {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .room-display {
      font-size: 14px;
      padding: 6px 12px;
      border-radius: 8px;
      background: #111;
      border: 1px solid #333;
      color: #999;
    }
    
    .room-id {
      color: #fff;
      font-weight: 700;
      font-size: 16px;
      letter-spacing: 1px;
    }
    
    button {
      font-size: 14px;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      background: #1f6feb;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
      touch-action: manipulation;
    }
    
    button:active {
      background: #1566d6;
    }
    
    button.secondary {
      background: #333;
    }
    
    button.secondary:active {
      background: #444;
    }
    
    .canvas-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      overflow: hidden;
      min-height: 0;
    }
    
    #pad {
      width: 100%;
      max-width: 100%;
      aspect-ratio: 3/4; /* ÏÑ∏Î°ú Î™®Îìú ÎπÑÏú® (Í∞ÄÎ°ú:ÏÑ∏Î°ú = 3:4) */
      border: 2px solid #333;
      border-radius: 12px;
      touch-action: none;
      background: #0f0f0f;
    }
    
    .controls {
      padding: 12px 16px;
      display: flex;
      gap: 10px;
      justify-content: center;
      border-top: 1px solid #333;
      flex-shrink: 0;
    }
    
    .pill {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 999px;
      background: #222;
      border: 1px solid #333;
      font-size: 11px;
    }
    
    .ok {
      background: #123b1f;
      border-color: #1f7a3a;
      color: #00ff88;
    }
    
    .bad {
      background: #3b1212;
      border-color: #7a1f1f;
      color: #ff6b6b;
    }

    /* Í∞ÄÎ°ú Î™®Îìú Í≤ΩÍ≥† */
    .landscape-warning {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
    }
    
    .landscape-warning.show {
      display: flex;
    }
    
    .rotate-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }
    
    .landscape-warning-text {
      font-size: 18px;
      font-weight: 600;
    }
    
    @media screen and (orientation: landscape) and (max-height: 500px) {
      .landscape-warning {
        display: flex;
      }
      .header, .canvas-container, .controls {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Í∞ÄÎ°ú Î™®Îìú Í≤ΩÍ≥† -->
  <div class="landscape-warning">
    <div class="rotate-icon">üì±</div>
    <div class="landscape-warning-text">Please rotate to portrait mode</div>
  </div>

  <div class="header">
    <div class="title">Chalkboard Assistant</div>
    <div class="room-info">
      <span class="room-display">Room: <span class="room-id" id="roomDisplay">-</span></span>
      <span id="conn" class="pill bad">Waiting</span>
    </div>
  </div>

  <div class="canvas-container">
    <canvas id="pad"></canvas>
  </div>

  <div class="controls">
    <button id="btnSend">Send</button>
    <button id="btnClear" class="secondary">Clear</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getDatabase, ref, set, push, onValue, serverTimestamp, onDisconnect
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    // ====== Firebase Config ======
    const firebaseConfig = {
      apiKey: "AIzaSyB8OTEF1deQf0tLMElQAH3iyMFcRnL_2lI",
      authDomain: "syz-test.firebaseapp.com",
      databaseURL: "https://syz-test-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "syz-test",
      appId: "1:85684795276:web:eb64abb9dd16ee30e788a9",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const $ = (id) => document.getElementById(id);
    const roomDisplay = $("roomDisplay");
    const connPill = $("conn");

    // URLÏóêÏÑú room ÌååÎùºÎØ∏ÌÑ∞ ÏùΩÍ∏∞
    const qs = new URLSearchParams(location.search);
    const roomId = String(qs.get("room") || "").trim().toUpperCase();
    
    if (!roomId) {
      alert("No Room ID provided in URL");
      roomDisplay.textContent = "ERROR";
    } else {
      roomDisplay.textContent = roomId;
      console.log("üîå Room ID:", roomId);
    }

    const clientId = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random().toString(16).slice(2));
    let isDbConnected = false;
    let seq = 0;

    // ====== DB Ïó∞Í≤∞ ÏÉÅÌÉú ======
    onValue(ref(db, ".info/connected"), (snap) => {
      isDbConnected = !!snap.val();
      connPill.textContent = isDbConnected ? "‚úÖ Connected" : "Waiting";
      connPill.className = "pill " + (isDbConnected ? "ok" : "bad");
    });

    // ====== ÏûêÎèô Ïó∞Í≤∞ ======
    async function connect() {
      if (!roomId) return;

      console.log("üîå Connecting to room:", roomId);

      // presence ÏÑ§Ï†ï
      const pRef = ref(db, `rooms/${roomId}/presence/assistant/${clientId}`);
      try {
        await onDisconnect(pRef).set({ online: false, ts: serverTimestamp(), clientId });
        await set(pRef, { online: true, ts: serverTimestamp(), clientId, ua: navigator.userAgent });
        console.log("‚úÖ Connected");
      } catch (e) {
        console.error("‚ùå Connection failed:", e);
        alert("Connection failed: " + e.message);
      }
    }

    // URLÏóê roomÏù¥ ÏûàÏúºÎ©¥ ÏûêÎèô Ïó∞Í≤∞
    if (roomId) connect();

    // ====== Canvas Í∑∏Î¶¨Í∏∞ ======
    const canvas = $("pad");
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      
      // Ïã§Ï†ú Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞Î•º rect ÌÅ¨Í∏∞ÏôÄ ÎèôÏùºÌïòÍ≤å ÏÑ§Ï†ï
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      
      // Ïä§ÏºÄÏùº Î≥ÄÌôò Ï†ÅÏö©
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      
      ctx.lineWidth = 3;
      ctx.lineJoin = "round";
      ctx.lineCap = "round";
      ctx.strokeStyle = "#ffffff";
      
      clearLocal();
    }

    function clearLocal() {
      const rect = canvas.getBoundingClientRect();
      ctx.clearRect(0, 0, rect.width, rect.height);
      ctx.fillStyle = "#0f0f0f";
      ctx.fillRect(0, 0, rect.width, rect.height);
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    let drawing = false;
    let currentStroke = [];
    let strokes = [];

    function pointFromEvent(e) {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX ?? e.touches?.[0]?.clientX) - rect.left;
      const y = (e.clientY ?? e.touches?.[0]?.clientY) - rect.top;
      return { x, y };
    }

    function beginStroke(p) {
      drawing = true;
      currentStroke = [p];
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
    }

    function moveStroke(p) {
      if (!drawing) return;
      currentStroke.push(p);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
    }

    function endStroke(p) {
      if (!drawing) return;
      drawing = false;
      if (p) currentStroke.push(p);
      if (currentStroke.length >= 2) strokes.push(currentStroke);
      currentStroke = [];
    }

    canvas.addEventListener("pointerdown", (e) => {
      canvas.setPointerCapture(e.pointerId);
      beginStroke(pointFromEvent(e));
    });
    canvas.addEventListener("pointermove", (e) => moveStroke(pointFromEvent(e)));
    canvas.addEventListener("pointerup", (e) => endStroke(pointFromEvent(e)));
    canvas.addEventListener("pointercancel", () => endStroke());

    // ====== Firebase Ï†ÑÏÜ° ======
    async function writeBoth(payload) {
      if (!roomId) {
        alert("No Room ID");
        return;
      }

      const latestPath = `rooms/${roomId}/latest`;
      const eventsPath = `rooms/${roomId}/events`;

      await set(ref(db, latestPath), payload);
      await push(ref(db, eventsPath), payload);

      console.log("‚úÖ Sent:", payload.type);
    }

    $("btnSend").addEventListener("click", async () => {
      if (!isDbConnected) {
        alert("Not connected to database");
        return;
      }
      
      if (strokes.length === 0) {
        alert("No drawing to send");
        return;
      }

      // iPadÍ∞Ä Ïù¥Ìï¥ÌïòÎäî ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
      const rect = canvas.getBoundingClientRect();
      
      const formattedStrokes = strokes.map(pointArray => ({
        points: pointArray.map(p => ({ 
          x: p.x,
          y: p.y
        })),
        width: 15,
        tool: "chalk",
        canvasWidth: rect.width,
        canvasHeight: rect.height
      }));

      const payload = {
        type: "strokes",
        data: formattedStrokes,
        from: "assistant",
        clientId,
        seq: ++seq,
        ts: serverTimestamp(),
      };

      try {
        await writeBoth(payload);
        console.log(`üì§ Sent: ${formattedStrokes.length} strokes (${rect.width}x${rect.height})`);
      } catch (e) {
        console.error("‚ùå Send failed:", e);
        alert("Send failed: " + e.message);
      }
    });

    $("btnClear").addEventListener("click", async () => {
      const payload = {
        type: "clear",
        from: "assistant",
        clientId,
        seq: ++seq,
        ts: serverTimestamp(),
      };
      
      try {
        await writeBoth(payload);
        strokes = [];
        clearLocal();
        console.log("üßπ Cleared");
      } catch (e) {
        console.error("‚ùå Clear failed:", e);
        alert("Clear failed: " + e.message);
      }
    });
  </script>
</body>
</html>
