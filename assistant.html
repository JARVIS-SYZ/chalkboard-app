<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chalkboard Assistant</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 16px; background:#0b0b0b; color:#fff; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input, button { font-size: 16px; padding: 10px 12px; border-radius:10px; border: 1px solid #333; }
    input { background:#111; color:#fff; }
    button { background:#1f6feb; color:#fff; border:none; font-weight:700; }
    button.secondary { background:#222; }
    #log { white-space: pre-wrap; background: #111; color: #ddd; padding: 12px; border-radius: 12px; margin-top: 12px; border:1px solid #222; max-height: 400px; overflow-y: auto; }
    #pad { width: 100%; height: 320px; border: 1px solid #333; border-radius: 14px; touch-action: none; background:#0f0f0f; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; background:#222; border:1px solid #333; font-size:12px; }
    .ok { background:#123b1f; border-color:#1f7a3a; }
    .bad { background:#3b1212; border-color:#7a1f1f; }
    .muted { color:#bdbdbd; font-size:12px; }
  </style>
</head>
<body>
  <h2 style="margin:0 0 8px 0;">Chalkboard Assistant</h2>

  <div class="row" style="margin-bottom:10px;">
    <span class="muted">Room</span>
    <input id="room" placeholder="6ìë¦¬ Room ID" maxlength="6" />
    <button id="btnConnect">ì—°ê²°</button>
    <span id="conn" class="pill bad">DB ëŠê¹€</span>
    <span id="presence" class="pill bad">presence: off</span>
  </div>

  <p class="muted" style="margin-top:0;">
    ì•„ë˜ íŒ¨ë“œì— ì„ ì„ ê·¸ë¦¬ê³  <b>ì „ì†¡</b>ì„ ëˆ„ë¥´ë©´ iPadì— ê·¸ë¦¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
  </p>

  <canvas id="pad"></canvas>

  <div class="row" style="margin-top:10px;">
    <button id="btnSend">ì „ì†¡</button>
    <button id="btnClear" class="secondary">ì§€ìš°ê¸°(í´ë¦¬ì–´ ì´ë²¤íŠ¸)</button>
    <button id="btnReset" class="secondary">ë¡œì»¬ ë¦¬ì…‹</button>
  </div>

  <div id="log"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getDatabase, ref, set, push, onValue, serverTimestamp, onDisconnect
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    // ====== Firebase Web Config ======
    const firebaseConfig = {
      apiKey: "AIzaSyB8OTEF1deQf0tLMElQAH3iyMFcRnL_2lI",
      authDomain: "syz-test.firebaseapp.com",
      databaseURL: "https://syz-test-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "syz-test",
      appId: "1:85684795276:web:eb64abb9dd16ee30e788a9",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const $ = (id) => document.getElementById(id);
    const roomInput = $("room");
    const connPill = $("conn");
    const presencePill = $("presence");
    const logEl = $("log");

    const qs = new URLSearchParams(location.search);
    if (qs.get("room")) roomInput.value = String(qs.get("room")).trim().toUpperCase();

    const clientId = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random().toString(16).slice(2));
    let roomId = "";
    let isDbConnected = false;
    let seq = 0;

    function log(...args) {
      const msg = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
      logEl.textContent = msg + "\n\n" + logEl.textContent;
    }

    // ====== .info/connected ======
    onValue(ref(db, ".info/connected"), (snap) => {
      isDbConnected = !!snap.val();
      connPill.textContent = isDbConnected ? "DB ì—°ê²°ë¨" : "DB ëŠê¹€";
      connPill.className = "pill " + (isDbConnected ? "ok" : "bad");
    });

    async function connect() {
      roomId = String(roomInput.value || "").trim().toUpperCase();
      if (!roomId) {
        alert("roomIdë¥¼ ì…ë ¥í•˜ì„¸ìš”");
        return;
      }
      log("ğŸ”Œ connect:", { roomId, clientId });

      // presence: rooms/<room>/presence/assistant/<clientId>
      const pRef = ref(db, `rooms/${roomId}/presence/assistant/${clientId}`);

      // onDisconnect ë“±ë¡
      try {
        await onDisconnect(pRef).set({ online: false, ts: serverTimestamp(), clientId });
      } catch (e) {
        log("âš ï¸ onDisconnect ë“±ë¡ ì‹¤íŒ¨:", String(e));
      }

      // ì§€ê¸ˆ ì˜¨ë¼ì¸ í‘œì‹œ
      try {
        await set(pRef, { online: true, ts: serverTimestamp(), clientId, ua: navigator.userAgent });
        presencePill.textContent = "presence: on";
        presencePill.className = "pill ok";
      } catch (e) {
        presencePill.textContent = "presence: err";
        presencePill.className = "pill bad";
        log("âŒ presence set ì‹¤íŒ¨:", String(e));
      }

      // ë””ë²„ê·¸: latestê°€ ë³´ì´ëŠ”ì§€ í•œë²ˆ ì½ì–´ë³´ê¸°(ì„ íƒ)
      const latestRef = ref(db, `rooms/${roomId}/latest`);
      onValue(latestRef, (s) => {
        const v = s.val();
        if (v) log("ğŸ‘€ latest now:", v);
      }, { onlyOnce: true });

      log("âœ… connected ready");
    }

    // ====== Drawing pad ======
    const canvas = $("pad");
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.lineWidth = 3;
      ctx.lineJoin = "round";
      ctx.lineCap = "round";
      ctx.strokeStyle = "#ffffff";
      clearLocal();
    }

    function clearLocal() {
      const rect = canvas.getBoundingClientRect();
      ctx.clearRect(0, 0, rect.width, rect.height);
      ctx.fillStyle = "#0f0f0f";
      ctx.fillRect(0, 0, rect.width, rect.height);
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    let drawing = false;
    let currentStroke = [];
    let strokes = [];

    function pointFromEvent(e) {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX ?? e.touches?.[0]?.clientX) - rect.left;
      const y = (e.clientY ?? e.touches?.[0]?.clientY) - rect.top;
      return { x, y, t: Date.now() };
    }

    function beginStroke(p) {
      drawing = true;
      currentStroke = [p];
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
    }

    function moveStroke(p) {
      if (!drawing) return;
      currentStroke.push(p);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
    }

    function endStroke(p) {
      if (!drawing) return;
      drawing = false;
      if (p) currentStroke.push(p);
      if (currentStroke.length >= 2) strokes.push(currentStroke);
      currentStroke = [];
    }

    canvas.addEventListener("pointerdown", (e) => {
      canvas.setPointerCapture(e.pointerId);
      beginStroke(pointFromEvent(e));
    });
    canvas.addEventListener("pointermove", (e) => moveStroke(pointFromEvent(e)));
    canvas.addEventListener("pointerup", (e) => endStroke(pointFromEvent(e)));
    canvas.addEventListener("pointercancel", () => endStroke());

    // ====== Send Payload ======
    async function writeBoth(payload) {
      if (!roomId) await connect();

      const latestPath = `rooms/${roomId}/latest`;
      const eventsPath = `rooms/${roomId}/events`;

      // 1) latest overwrite
      await set(ref(db, latestPath), payload);
      // 2) events append
      await push(ref(db, eventsPath), payload);

      log("âœ… writeBoth:", { latestPath, eventsPath, type: payload.type, seq: payload.seq, strokeCount: payload.data?.length });
    }

    $("btnConnect").addEventListener("click", connect);

    $("btnSend").addEventListener("click", async () => {
      if (!isDbConnected) log("âš ï¸ DB ì—°ê²°ì´ ë¶ˆì•ˆì •í•  ìˆ˜ ìˆìŒ(.info/connected=false)");
      
      if (strokes.length === 0) {
        log("âš ï¸ ì „ì†¡í•  ê·¸ë¦¼ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê·¸ë¦¼ì„ ê·¸ë ¤ì£¼ì„¸ìš”.");
        return;
      }

      // iPadê°€ ì´í•´í•  ìˆ˜ ìˆëŠ” í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      const formattedStrokes = strokes.map(pointArray => ({
        points: pointArray.map(p => ({ x: p.x, y: p.y })), // t ì œê±°, x,yë§Œ
        width: 15, // ê¸°ë³¸ ë¶„í•„ êµµê¸°
        tool: "chalk" // ë¶„í•„ ë„êµ¬
      }));

      const payload = {
        type: "strokes",
        data: formattedStrokes,
        from: "assistant",
        clientId,
        seq: ++seq,
        ts: serverTimestamp(),
      };

      log("ğŸ“¤ ì „ì†¡ ë°ì´í„°:", { strokeCount: formattedStrokes.length, totalPoints: formattedStrokes.reduce((sum, s) => sum + s.points.length, 0) });

      try {
        await writeBoth(payload);
        log("âœ… ì „ì†¡ ì™„ë£Œ!");
      } catch (e) {
        log("âŒ send ì‹¤íŒ¨:", String(e));
      }
    });

    $("btnClear").addEventListener("click", async () => {
      const payload = {
        type: "clear",
        from: "assistant",
        clientId,
        seq: ++seq,
        ts: serverTimestamp(),
      };
      try {
        await writeBoth(payload);
        strokes = [];
        clearLocal();
        log("ğŸ§¹ í´ë¦¬ì–´ ì „ì†¡ ì™„ë£Œ");
      } catch (e) {
        log("âŒ clear ì‹¤íŒ¨:", String(e));
      }
    });

    $("btnReset").addEventListener("click", () => {
      strokes = [];
      clearLocal();
      log("â†©ï¸ local reset");
    });

    // ìë™ ì—°ê²°(ì¿¼ë¦¬ì— room ìˆìœ¼ë©´)
    if (roomInput.value) connect();
  </script>
</body>
</html>
