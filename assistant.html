<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chalkboard Assistant</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 16px; background:#0b0b0b; color:#fff; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input, button { font-size: 16px; padding: 10px 12px; border-radius:10px; border: 1px solid #333; }
    input { background:#111; color:#fff; }
    button { background:#1f6feb; color:#fff; border:none; font-weight:700; }
    button.secondary { background:#222; }
    #log { white-space: pre-wrap; background: #111; color: #ddd; padding: 12px; border-radius: 12px; margin-top: 12px; border:1px solid #222; }
    #pad { width: 100%; height: 320px; border: 1px solid #333; border-radius: 14px; touch-action: none; background:#0f0f0f; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; background:#222; border:1px solid #333; font-size:12px; }
    .ok { background:#123b1f; border-color:#1f7a3a; }
    .bad { background:#3b1212; border-color:#7a1f1f; }
    .muted { color:#bdbdbd; font-size:12px; }
  </style>
</head>
<body>
  <h2 style="margin:0 0 8px 0;">Chalkboard Assistant</h2>

  <div class="row" style="margin-bottom:10px;">
    <span class="muted">Room</span>
    <input id="room" placeholder="6-digit Room ID" maxlength="6" />
    <button id="btnConnect">Connect</button>
    <span id="conn" class="pill bad">DB Disconnected</span>
    <span id="presence" class="pill bad">presence: off</span>
  </div>

  <p class="muted" style="margin-top:0;">
    <b>Send</b>: Send to iPad, then clear iPhone screen<br>
    <b>Clear All</b>: Delete all drawings including iPad<br>
    <b>Clear iPhone</b>: Clear iPhone screen only (iPad unaffected)
  </p>

  <canvas id="pad"></canvas>

  <div class="row" style="margin-top:10px;">
    <button id="btnSend">Send</button>
    <button id="btnClear" class="secondary">Clear All</button>
    <button id="btnReset" class="secondary">Clear iPhone</button>
  </div>

  <div id="log"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getDatabase, ref, set, push, onValue, serverTimestamp, onDisconnect
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    // ====== Firebase Web Config ======
    const firebaseConfig = {
      apiKey: "AIzaSyB8OTEF1deQf0tLMElQAH3iyMFcRnL_2lI",
      authDomain: "syz-test.firebaseapp.com",
      databaseURL: "https://syz-test-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "syz-test",
      appId: "1:85684795276:web:eb64abb9dd16ee30e788a9",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const $ = (id) => document.getElementById(id);
    const roomInput = $("room");
    const connPill = $("conn");
    const presencePill = $("presence");
    const logEl = $("log");

    const qs = new URLSearchParams(location.search);
    if (qs.get("room")) roomInput.value = String(qs.get("room")).trim().toUpperCase();

    const clientId = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random().toString(16).slice(2));
    let roomId = "";
    let isDbConnected = false;
    let seq = 0;

    function log(...args) {
      const msg = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
      logEl.textContent = msg + "\n\n" + logEl.textContent;
    }

    // ====== .info/connected ======
    onValue(ref(db, ".info/connected"), (snap) => {
      isDbConnected = !!snap.val();
      connPill.textContent = isDbConnected ? "DB Connected" : "DB Disconnected";
      connPill.className = "pill " + (isDbConnected ? "ok" : "bad");
    });

    async function connect() {
      roomId = String(roomInput.value || "").trim().toUpperCase();
      if (!roomId) {
        alert("Please enter room ID");
        return;
      }
      log("üîå connect:", { roomId, clientId });

      const pRef = ref(db, `rooms/${roomId}/presence/assistant/${clientId}`);

      try {
        await onDisconnect(pRef).set({ online: false, ts: serverTimestamp(), clientId });
      } catch (e) {
        log("‚ö†Ô∏è onDisconnect Îì±Î°ù Ïã§Ìå®:", String(e));
      }

      try {
        await set(pRef, { online: true, ts: serverTimestamp(), clientId, ua: navigator.userAgent });
        presencePill.textContent = "presence: on";
        presencePill.className = "pill ok";
      } catch (e) {
        presencePill.textContent = "presence: err";
        presencePill.className = "pill bad";
        log("‚ùå presence set Ïã§Ìå®:", String(e));
      }

      log("‚úÖ connected ready");
    }

    // ====== Drawing pad ======
    const canvas = $("pad");
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.lineWidth = 3;
      ctx.lineJoin = "round";
      ctx.lineCap = "round";
      ctx.strokeStyle = "#ffffff";
      clearLocal();
    }

    function clearLocal() {
      const rect = canvas.getBoundingClientRect();
      ctx.clearRect(0, 0, rect.width, rect.height);
      ctx.fillStyle = "#0f0f0f";
      ctx.fillRect(0, 0, rect.width, rect.height);
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    let drawing = false;
    let currentStroke = [];
    let strokes = [];

    function pointFromEvent(e) {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX ?? e.touches?.[0]?.clientX) - rect.left;
      const y = (e.clientY ?? e.touches?.[0]?.clientY) - rect.top;
      return { x, y, t: Date.now() };
    }

    function beginStroke(p) {
      drawing = true;
      currentStroke = [p];
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
    }

    function moveStroke(p) {
      if (!drawing) return;
      currentStroke.push(p);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
    }

    function endStroke(p) {
      if (!drawing) return;
      drawing = false;
      if (p) currentStroke.push(p);
      if (currentStroke.length >= 2) {
        const rect = canvas.getBoundingClientRect();
        strokes.push({
          points: currentStroke,
          canvasWidth: rect.width,
          canvasHeight: rect.height,
        });
      }
      currentStroke = [];
    }

    canvas.addEventListener("pointerdown", (e) => {
      canvas.setPointerCapture(e.pointerId);
      beginStroke(pointFromEvent(e));
    });
    canvas.addEventListener("pointermove", (e) => moveStroke(pointFromEvent(e)));
    canvas.addEventListener("pointerup", (e) => endStroke(pointFromEvent(e)));
    canvas.addEventListener("pointercancel", () => endStroke());

    // ====== Send Payload ======
    async function writeBoth(payload) {
      if (!roomId) await connect();

      const latestPath = `rooms/${roomId}/latest`;
      const eventsPath = `rooms/${roomId}/events`;

      await set(ref(db, latestPath), payload);
      await push(ref(db, eventsPath), payload);

      log("‚úÖ writeBoth:", { latestPath, eventsPath, type: payload.type, seq: payload.seq });
    }

    $("btnConnect").addEventListener("click", connect);

    $("btnSend").addEventListener("click", async () => {
      if (!isDbConnected) log("‚ö†Ô∏è DB Ïó∞Í≤∞Ïù¥ Î∂àÏïàÏ†ïÌï† Ïàò ÏûàÏùå(.info/connected=false)");
      
      if (strokes.length === 0) {
        log("‚ö†Ô∏è Í∑∏Î¶∞ ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§");
        return;
      }
      
      const payload = {
        type: "strokes",
        data: strokes,
        from: "assistant",
        clientId,
        seq: ++seq,
        ts: serverTimestamp(),
      };
      
      try {
        await writeBoth(payload);
        log("‚úÖ iPadÎ°ú Ï†ÑÏÜ° ÏôÑÎ£å!");
        
        strokes = [];
        clearLocal();
        log("üßπ iPhone ÌôîÎ©¥ ÌÅ¥Î¶¨Ïñ¥Îê® (iPadÎäî Ïú†ÏßÄ)");
        
      } catch (e) {
        log("‚ùå Ï†ÑÏÜ° Ïã§Ìå®:", String(e));
      }
    });

    $("btnClear").addEventListener("click", async () => {
      const payload = {
        type: "clear",
        from: "assistant",
        clientId,
        seq: ++seq,
        ts: serverTimestamp(),
      };
      try {
        await writeBoth(payload);
        strokes = [];
        clearLocal();
        log("‚úÖ Ï†ÑÏ≤¥ ÌÅ¥Î¶¨Ïñ¥! (iPad Ìè¨Ìï®)");
      } catch (e) {
        log("‚ùå Ï†ÑÏ≤¥ ÌÅ¥Î¶¨Ïñ¥ Ïã§Ìå®:", String(e));
      }
    });

    $("btnReset").addEventListener("click", () => {
      strokes = [];
      clearLocal();
      log("üßπ iPhone ÌôîÎ©¥Îßå ÌÅ¥Î¶¨Ïñ¥Îê® (iPadÎäî ÏòÅÌñ• ÏóÜÏùå)");
    });

    if (roomInput.value) connect();
  </script>
</body>
</html>
